/* jshint node: true */
'use strict';

var mappings = {
  offer: {
    // audio toggle
    // { audio: false } in peer connection config turns off audio
    audio: function(c) {
      c.mandatory = c.mandatory || {};
      c.mandatory.OfferToReceiveAudio = true;
    },

    // video toggle
    // { video: false } in peer connection config turns off video
    video: function(c) {
      c.mandatory = c.mandatory || {};
      c.mandatory.OfferToReceiveVideo = true;
    }
  },

  create: {
    // data enabler
    // { data: true } in peer connection will enable video
    data: function(c) {
       c.optional = (c.optional || []).concat({ RtpDataChannels: true });
    }
  } 
};

// initialise known flags
var knownFlags = ['video', 'audio', 'data'];

/**
  ## rtc/generators

  The generators package provides some utility methods for generating
  constraint objects and similar constructs.  Primarily internal use.

  ```js
  var generators = require('rtc/generators');
  ```

**/

/**
  ### generators.config(config)

  Generate a configuration object suitable for passing into an W3C 
  RTCPeerConnection constructor first argument, based on our custom config.
**/
exports.config = function(config) {
  var baseConfig = {
    iceServers: [
      { url: 'stun:stun.l.google.com:19302' }
    ]
  };

  // if we have ice servers provided in the config, override the base config
  ['iceServers'].forEach(function(key) {
    if (config[key]) {
      baseConfig[key] = config[key];
    }
  });

  return baseConfig;
};

/**
  ### generators.mediaConstraints(flags, context)

  Generate mediaConstraints appropriate for the context in which they are 
  being called (i.e. either constructing an RTCPeerConnection object, or
  on the `createOffer` or `createAnswer` calls).
**/
exports.mediaConstraints = function(flags, context) {
  // create an empty constraints object
  var constraints = {
    optional: [{ DtlsSrtpKeyAgreement: true }]
  };

  // provide default mandatory constraints for the offer
  if (context === 'offer') {
    constraints.mandatory = {
      OfferToReceiveVideo: false,
      OfferToReceiveAudio: false
    };
  };

  // get the mappings for the context (defaulting to the offer context)
  var contextMappings = mappings[context || 'offer'] || {};

  // if we haven't been passed an array for flags, then return the constraints
  if (! Array.isArray(flags)) {
    flags = parseFlags(flags);
  }

  flags.map(function(flag) {
    if (typeof contextMappings[flag] == 'function') {
      // mutate the constraints
      contextMappings[flag](constraints);
    }
  });

  return constraints;
};

/**
  ### parseFlags(opts)

  This is a helper function that will extract known flags from a generic 
  options object.
**/
var parseFlags = exports.parseFlags = function(options) {
  // ensure we have opts
  var opts = options || {};

  // default video and audio flags to true if undefined
  opts.video = opts.video || typeof opts.video == 'undefined';
  opts.audio = opts.audio || typeof opts.audio == 'undefined';

  return Object.keys(opts || {})
    .filter(function(flag) {
      return opts[flag];
    })
    .map(function(flag) {
      return flag.toLowerCase();
    })
    .filter(function(flag) {
      return knownFlags.indexOf(flag) >= 0;
    });
};