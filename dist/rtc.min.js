!function(e){if("function"==typeof bootstrap)bootstrap("rtc",e);else if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeRtc=e}else"undefined"!=typeof window?window.rtc=e():global.rtc=e()}(function(){var define,ses,bootstrap,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";var debug=require("cog/logger")("couple");var monitor=require("./monitor");var detect=require("./detect");var RTCSessionDescription=detect("RTCSessionDescription");var RTCIceCandidate=detect("RTCIceCandidate");module.exports=function(conn,targetAttr,signaller,opts){var mon=monitor(conn);var blockId;var createAnswer=createHandshaker("createAnswer");var createOffer=createHandshaker("createOffer");var openChannel;var queuedCandidates=[];var sdpFilter=(opts||{}).sdpfilter;function abort(err){debug("captured error: ",err);signaller.clearBlock(blockId)}function createHandshaker(methodName){var hsDebug=require("cog/logger")("handshake-"+methodName);return function(){openChannel=null;hsDebug("starting, making signaller request",conn.signalingState);signaller.request(targetAttr,function(err,channel){if(err){return}hsDebug("request ok");blockId=signaller.block();conn[methodName](function(desc){if(typeof sdpFilter=="function"){desc.sdp=sdpFilter(desc.sdp,conn,methodName)}conn.setLocalDescription(desc,function(){openChannel=channel;channel.send("/sdp",desc);signaller.clearBlock(blockId);hsDebug("block cleared")},abort)},abort)})}}function handleLocalCandidate(evt){if(evt.candidate&&openChannel){openChannel.send("/candidate",evt.candidate)}}function handleRemoteCandidate(data){if(!conn.remoteDescription){return queuedCandidates.push(data)}debug("adding remote candidate");conn.addIceCandidate(new RTCIceCandidate(data))}function handleSdp(data){conn.setRemoteDescription(new RTCSessionDescription(data),function(){queuedCandidates.splice(0).forEach(function(data){debug("applying queued candidate");conn.addIceCandidate(new RTCIceCandidate(data))});if(data.type==="offer"){createAnswer()}},abort)}conn.addEventListener("negotiationneeded",createOffer);conn.addEventListener("icecandidate",handleLocalCandidate);signaller.on("sdp",handleSdp);signaller.on("candidate",handleRemoteCandidate);mon.once("closed",function(){debug("closed");signaller.removeListener("sdp",handleSdp);signaller.removeListener("candidate",handleRemoteCandidate)});mon.createOffer=createOffer;return mon}},{"./detect":2,"./monitor":6,"cog/logger":12}],2:[function(require,module,exports){"use strict";module.exports=require("rtc-core/detect")},{"rtc-core/detect":13}],3:[function(require,module,exports){"use strict";var detect=require("./detect");var defaults=require("cog/defaults");var mappings={offer:{audio:function(c){c.mandatory=c.mandatory||{};c.mandatory.OfferToReceiveAudio=true},video:function(c){c.mandatory=c.mandatory||{};c.mandatory.OfferToReceiveVideo=true}},create:{data:function(c){if(!detect.moz){c.optional=(c.optional||[]).concat({RtpDataChannels:true})}},dtls:function(c){if(!detect.moz){c.optional=(c.optional||[]).concat({DtlsSrtpKeyAgreement:true})}}}};var knownFlags=["video","audio","data"];exports.config=function(config){return defaults(config,{iceServers:[]})};exports.connectionConstraints=function(flags,constraints){var generated={};var m=mappings.create;Object.keys(flags||{}).forEach(function(key){if(m[key]){m[key](generated)}});return defaults({},constraints,generated)};exports.mediaConstraints=function(flags,context){var constraints={optional:[{DtlsSrtpKeyAgreement:true}]};if(context==="offer"){constraints.mandatory={OfferToReceiveVideo:false,OfferToReceiveAudio:false}}var contextMappings=mappings[context||"offer"]||{};if(!Array.isArray(flags)){flags=parseFlags(flags)}flags.map(function(flag){if(typeof contextMappings[flag]=="function"){contextMappings[flag](constraints)}});return constraints};var parseFlags=exports.parseFlags=function(options){var opts=options||{};opts.video=opts.video||typeof opts.video=="undefined";opts.audio=opts.audio||typeof opts.audio=="undefined";return Object.keys(opts||{}).filter(function(flag){return opts[flag]}).map(function(flag){return flag.toLowerCase()}).filter(function(flag){return knownFlags.indexOf(flag)>=0})}},{"./detect":2,"cog/defaults":10}],4:[function(require,module,exports){"use strict";var gen=require("./generators");var detect=exports.detect=require("./detect");exports.logger=require("cog/logger");var RTCPeerConnection=exports.RTCPeerConnection=detect("RTCPeerConnection");exports.couple=require("./couple");exports.media=require("./media");exports.signaller=require("rtc-signaller");exports.createConnection=function(opts,constraints){return new RTCPeerConnection(gen.config(opts),gen.connectionConstraints(opts,constraints))}},{"./couple":1,"./detect":2,"./generators":3,"./media":5,"cog/logger":12,"rtc-signaller":18}],5:[function(require,module,exports){"use strict";module.exports=require("rtc-media")},{"rtc-media":14}],6:[function(require,module,exports){var process=require("__browserify_process");"use strict";var debug=require("cog/logger")("monitor");var EventEmitter=require("events").EventEmitter;var W3C_STATES={NEW:"new",LOCAL_OFFER:"have-local-offer",LOCAL_PRANSWER:"have-local-pranswer",REMOTE_PRANSWER:"have-remote-pranswer",ACTIVE:"active",CLOSED:"closed"};var monitor=module.exports=function(pc,tag){var mon=new EventEmitter;var currentState=getState(pc);var isActive=mon.active=currentState===W3C_STATES.ACTIVE;function checkState(){var newState=getState(pc,tag);debug("captured state change, new state: "+newState+", current state: "+currentState);mon.active=newState===W3C_STATES.ACTIVE;if(newState!==currentState){mon.emit(currentState=newState)}}if(isActive){process.nextTick(mon.emit.bind(mon,W3C_STATES.ACTIVE,pc))}pc.addEventListener("signalingstatechange",checkState);pc.addEventListener("iceconnectionstatechange",checkState);mon.stop=function(){pc.removeEventListener("signalingstatechange",checkState);pc.removeEventListener("iceconnectionstatechange",checkState)};return mon};var getState=monitor.getState=function(pc,tag){var signalingState=pc&&pc.signalingState;var iceGatheringState=pc&&pc.iceGatheringState;var iceConnectionState=pc&&pc.iceConnectionState;var localDesc;var remoteDesc;var state;var isActive;if(!pc){return W3C_STATES.CLOSED}tag=tag||"";localDesc=pc.localDescription;remoteDesc=pc.remoteDescription;state=signalingState;if(state==="stable"){state=W3C_STATES.NEW;if(localDesc&&remoteDesc){state=W3C_STATES.REMOTE_PRANSWER}}isActive=state===W3C_STATES.REMOTE_PRANSWER&&iceConnectionState==="connected";debug(tag+"signaling state: "+signalingState+", iceGatheringState: "+iceGatheringState+", iceConnectionState: "+iceConnectionState);return isActive?W3C_STATES.ACTIVE:state};monitor.isActive=function(pc){var isStable=pc&&pc.signalingState==="stable";return isStable&&getState(pc)===W3C_STATES.ACTIVE}},{__browserify_process:24,"cog/logger":12,events:8}],7:[function(require,module,exports){var toString=Object.prototype.toString;var hasOwnProperty=Object.prototype.hasOwnProperty;function isArray(xs){return toString.call(xs)==="[object Array]"}exports.isArray=typeof Array.isArray==="function"?Array.isArray:isArray;exports.indexOf=function indexOf(xs,x){if(xs.indexOf)return xs.indexOf(x);for(var i=0;i<xs.length;i++){if(x===xs[i])return i}return-1};exports.filter=function filter(xs,fn){if(xs.filter)return xs.filter(fn);var res=[];for(var i=0;i<xs.length;i++){if(fn(xs[i],i,xs))res.push(xs[i])}return res};exports.forEach=function forEach(xs,fn,self){if(xs.forEach)return xs.forEach(fn,self);for(var i=0;i<xs.length;i++){fn.call(self,xs[i],i,xs)}};exports.map=function map(xs,fn){if(xs.map)return xs.map(fn);var out=new Array(xs.length);for(var i=0;i<xs.length;i++){out[i]=fn(xs[i],i,xs)}return out};exports.reduce=function reduce(array,callback,opt_initialValue){if(array.reduce)return array.reduce(callback,opt_initialValue);var value,isValueSet=false;if(2<arguments.length){value=opt_initialValue;isValueSet=true}for(var i=0,l=array.length;l>i;++i){if(array.hasOwnProperty(i)){if(isValueSet){value=callback(value,array[i],i,array)}else{value=array[i];isValueSet=true}}}return value};if("ab".substr(-1)!=="b"){exports.substr=function(str,start,length){if(start<0)start=str.length+start;return str.substr(start,length)}}else{exports.substr=function(str,start,length){return str.substr(start,length)}}exports.trim=function(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,"")};exports.bind=function(){var args=Array.prototype.slice.call(arguments);var fn=args.shift();if(fn.bind)return fn.bind.apply(fn,args);var self=args.shift();return function(){fn.apply(self,args.concat([Array.prototype.slice.call(arguments)]))}};function create(prototype,properties){var object;if(prototype===null){object={__proto__:null}}else{if(typeof prototype!=="object"){throw new TypeError("typeof prototype["+typeof prototype+"] != 'object'")}var Type=function(){};Type.prototype=prototype;object=new Type;object.__proto__=prototype}if(typeof properties!=="undefined"&&Object.defineProperties){Object.defineProperties(object,properties)}return object}exports.create=typeof Object.create==="function"?Object.create:create;function notObject(object){return typeof object!="object"&&typeof object!="function"||object===null}function keysShim(object){if(notObject(object)){throw new TypeError("Object.keys called on a non-object")}var result=[];for(var name in object){if(hasOwnProperty.call(object,name)){result.push(name)}}return result}function propertyShim(object){if(notObject(object)){throw new TypeError("Object.getOwnPropertyNames called on a non-object")}var result=keysShim(object);if(exports.isArray(object)&&exports.indexOf(object,"length")===-1){result.push("length")}return result}var keys=typeof Object.keys==="function"?Object.keys:keysShim;var getOwnPropertyNames=typeof Object.getOwnPropertyNames==="function"?Object.getOwnPropertyNames:propertyShim;if((new Error).hasOwnProperty("description")){var ERROR_PROPERTY_FILTER=function(obj,array){if(toString.call(obj)==="[object Error]"){array=exports.filter(array,function(name){return name!=="description"&&name!=="number"&&name!=="message"})}return array};exports.keys=function(object){return ERROR_PROPERTY_FILTER(object,keys(object))};exports.getOwnPropertyNames=function(object){return ERROR_PROPERTY_FILTER(object,getOwnPropertyNames(object))}}else{exports.keys=keys;exports.getOwnPropertyNames=getOwnPropertyNames}function valueObject(value,key){return{value:value[key]}}if(typeof Object.getOwnPropertyDescriptor==="function"){try{Object.getOwnPropertyDescriptor({a:1},"a");exports.getOwnPropertyDescriptor=Object.getOwnPropertyDescriptor}catch(e){exports.getOwnPropertyDescriptor=function(value,key){try{return Object.getOwnPropertyDescriptor(value,key)}catch(e){return valueObject(value,key)}}}}else{exports.getOwnPropertyDescriptor=valueObject}},{}],8:[function(require,module,exports){var util=require("util");function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!util.isNumber(n)||n<0)throw TypeError("n must be a positive number");this._maxListeners=n;return this};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==="error"){if(!this._events.error||util.isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er}else{throw TypeError('Uncaught, unspecified "error" event.')}return false}}handler=this._events[type];if(util.isUndefined(handler))return false;if(util.isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];handler.apply(this,args)}}else if(util.isObject(handler)){len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)listeners[i].apply(this,args)}return true};EventEmitter.prototype.addListener=function(type,listener){var m;if(!util.isFunction(listener))throw TypeError("listener must be a function");if(!this._events)this._events={};if(this._events.newListener)this.emit("newListener",type,util.isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(util.isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(util.isObject(this._events[type])&&!this._events[type].warned){var m;if(!util.isUndefined(this._maxListeners)){m=this._maxListeners}else{m=EventEmitter.defaultMaxListeners}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error("(node) warning: possible EventEmitter memory "+"leak detected. %d listeners added. "+"Use emitter.setMaxListeners() to increase limit.",this._events[type].length);console.trace()}}return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!util.isFunction(listener))throw TypeError("listener must be a function");function g(){this.removeListener(type,g);listener.apply(this,arguments)}g.listener=listener;this.on(type,g);return this};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!util.isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||util.isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit("removeListener",type,listener)}else if(util.isObject(list)){for(i=length;i-->0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type]}else{list.splice(position,1)}if(this._events.removeListener)this.emit("removeListener",type,listener)}return this};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this}if(arguments.length===0){for(key in this._events){if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events={};return this}listeners=this._events[type];if(util.isFunction(listeners)){this.removeListener(type,listeners)}else{while(listeners.length)this.removeListener(type,listeners[listeners.length-1])}delete this._events[type];return this};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(util.isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret};EventEmitter.listenerCount=function(emitter,type){var ret;if(!emitter._events||!emitter._events[type])ret=0;else if(util.isFunction(emitter._events[type]))ret=1;else ret=emitter._events[type].length;return ret}},{util:9}],9:[function(require,module,exports){var shims=require("_shims");var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]))}return objects.join(" ")}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==="%%")return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=" "+x}else{str+=" "+inspect(x)}}return str};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts}else if(opts){exports._extend(ctx,opts)}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth)}exports.inspect=inspect;inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]};inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m"}else{return str}}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};shims.forEach(array,function(val,idx){hash[val]=true});return hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes)}return ret}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive}var keys=shims.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=shims.getOwnPropertyNames(value)}if(keys.length===0){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),"date")}if(isError(value)){return formatError(value)}}var base="",array=false,braces=["{","}"];if(isArray(value)){array=true;braces=["[","]"]}if(isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)){base=" "+RegExp.prototype.toString.call(value)}if(isDate(value)){base=" "+Date.prototype.toUTCString.call(value)}if(isError(value)){base=" "+formatError(value)}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1]}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}else{return ctx.stylize("[Object]","special")}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys)}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)})}ctx.seen.pop();return reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}if(isNumber(value))return ctx.stylize(""+value,"number");if(isBoolean(value))return ctx.stylize(""+value,"boolean");if(isNull(value))return ctx.stylize("null","null")}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true))}else{output.push("")}}shims.forEach(keys,function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true))}});return output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=shims.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize("[Getter/Setter]","special")}else{str=ctx.stylize("[Getter]","special")}}else{if(desc.set){str=ctx.stylize("[Setter]","special")}}if(!hasOwnProperty(visibleKeys,key)){name="["+key+"]"}if(!str){if(shims.indexOf(ctx.seen,desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null)}else{str=formatValue(ctx,desc.value,recurseTimes-1)}if(str.indexOf("\n")>-1){if(array){str=str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2)}else{str="\n"+str.split("\n").map(function(line){return"   "+line}).join("\n")}}}else{str=ctx.stylize("[Circular]","special")}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str}name=JSON.stringify(""+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,"name")}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,"string")}}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=shims.reduce(output,function(prev,cur){numLinesEst++;if(cur.indexOf("\n")>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);if(length>60){return braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]}return braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return shims.isArray(ar)}exports.isArray=isArray;function isBoolean(arg){return typeof arg==="boolean"}exports.isBoolean=isBoolean;function isNull(arg){return arg===null}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==="number"}exports.isNumber=isNumber;function isString(arg){return typeof arg==="string"}exports.isString=isString;function isSymbol(arg){return typeof arg==="symbol"}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==="[object RegExp]"}exports.isRegExp=isRegExp;function isObject(arg){return typeof arg==="object"&&arg}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==="[object Date]"}exports.isDate=isDate;function isError(e){return isObject(e)&&objectToString(e)==="[object Error]"}exports.isError=isError;function isFunction(arg){return typeof arg==="function"}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==="boolean"||typeof arg==="number"||typeof arg==="string"||typeof arg==="symbol"||typeof arg==="undefined"}exports.isPrimitive=isPrimitive;function isBuffer(arg){return arg instanceof Buffer}exports.isBuffer=isBuffer;function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var d=new Date;var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))};exports.inherits=function(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=shims.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})};exports._extend=function(origin,add){if(!add||!isObject(add))return origin;var keys=shims.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]]}return origin};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}},{_shims:7}],10:[function(require,module,exports){"use strict";module.exports=function(target){target=target||{};[].slice.call(arguments,1).forEach(function(source){if(!source){return}for(var prop in source){if(target[prop]===void 0){target[prop]=source[prop]}}});return target}},{}],11:[function(require,module,exports){"use strict";module.exports=function(target){[].slice.call(arguments,1).forEach(function(source){if(!source){return}for(var prop in source){target[prop]=source[prop]}});return target}},{}],12:[function(require,module,exports){"use strict";var active=[];var unleashListeners=[];var targets=[console];var logger=module.exports=function(name){var enabled=checkActive();function checkActive(){return enabled=active.indexOf("*")>=0||active.indexOf(name)>=0}unleashListeners[unleashListeners.length]=checkActive;return function(){var args=[].slice.call(arguments);if(typeof args[0]=="string"||args[0]instanceof String){args[0]=name+": "+args[0]}if(!enabled){return}targets.forEach(function(target){target.log.apply(target,args)})}};logger.reset=function(){targets=[];active=[];return logger.enable()};logger.to=function(target){targets=targets.concat(target||[]);return logger};logger.enable=function(){active=active.concat([].slice.call(arguments));unleashListeners.forEach(function(listener){listener()});return logger}},{}],13:[function(require,module,exports){"use strict";var detect=module.exports=function(target,prefixes){var prefixIdx;var prefix;var testName;var hostObject=this||window;prefixes=(prefixes||["ms","o","moz","webkit"]).concat("");for(prefixIdx=prefixes.length;prefixIdx--;){prefix=prefixes[prefixIdx];testName=prefix+(prefix?target.charAt(0).toUpperCase()+target.slice(1):target);if(typeof hostObject[testName]!="undefined"){detect.browser=detect.browser||prefix.toLowerCase();return hostObject[target]=hostObject[testName]}}};detect.moz=typeof navigator!="undefined"&&!!navigator.mozGetUserMedia;detect.browser=undefined},{}],14:[function(require,module,exports){"use strict";var debug=require("cog/logger")("media");var extend=require("cog/extend");var detect=require("rtc-core/detect");var EventEmitter=require("events").EventEmitter;var util=require("util");navigator.getUserMedia=detect.call(navigator,"getUserMedia");window.URL=window.URL||detect("URL");window.MediaStream=detect("MediaStream");function Media(opts){if(!(this instanceof Media)){return new Media(opts)}EventEmitter.call(this);if(opts&&opts instanceof MediaStream){opts={stream:opts,capture:false,muted:false}}if(opts&&(opts.audio||opts.video)){opts={constraints:opts}}opts=extend({},{capture:true,muted:true,constraints:{video:{mandatory:{},optional:[]},audio:true}},opts);this.constraints=opts.constraints;this.name=opts.name;this.stream=opts.stream||null;this.muted=typeof opts.muted=="undefined"||opts.muted;this._bindings=[];if(opts.capture){setTimeout(this.capture.bind(this),0)}}util.inherits(Media,EventEmitter);module.exports=Media;Media.prototype.capture=function(constraints,callback){var media=this;var handleEnd=this.emit.bind(this,"end");if(this.stream){return}if(typeof constraints=="function"){callback=constraints;constraints=this.constraints}if(typeof callback=="function"){this.once("capture",callback.bind(this))}navigator.getUserMedia(constraints||this.constraints,function(stream){if(typeof stream.addEventListener=="function"){stream.addEventListener("ended",handleEnd)}else{stream.onended=handleEnd}media.stream=stream;media.emit("capture",stream)},this._handleFail.bind(this))};Media.prototype.render=function(target,opts,callback){if(Array.isArray(target)){console.log("WARNING: rtc-media render (as of 1.x) expects a single target");target=target[0]}if(typeof opts=="function"){callback=opts;opts={}}opts=opts||{};target=this._prepareElement(opts,target);if(!this.stream){this.once("capture",this._bindStream.bind(this))}else{this._bindStream(this.stream)}if(typeof callback=="function"){this.once("render",callback)}return target};Media.prototype.stop=function(opts){var media=this;if(!this.stream){return}this._unbind(opts);this.stream.stop();this.once("capture",media._bindStream.bind(media));this.stream=null};Media.prototype._prepareElement=function(opts,element){var parent;var validElement=element instanceof HTMLVideoElement||element instanceof HTMLAudioElement;var preserveAspectRatio=typeof opts.preserveAspectRatio=="undefined"||opts.preserveAspectRatio;validElement=validElement||typeof element.play=="function"&&(typeof element.mozSrcObject!="undefined"||typeof element.src!="undefined");if(!validElement){parent=element;element=document.createElement("video");if(preserveAspectRatio){element.setAttribute("preserveAspectRatio","")}parent.appendChild(element);element.setAttribute("data-playing",false)}if(element&&this.muted){element.setAttribute("muted","")}this._bindings.push({el:element,opts:opts});return element};Media.prototype._bindStream=function(stream){var media=this;var elements=[];var waiting=[];function checkWaiting(){if(waiting.length===0&&elements.length>0){media.emit("render",elements);elements.map(function(el){el.setAttribute("data-playing",true)})}}function playbackStarted(evt){var videoIndex=elements.indexOf(evt.srcElement);if(videoIndex>=0){waiting.splice(videoIndex,1)}evt.srcElement.removeEventListener("playing",playbackStarted);checkWaiting()}elements=this._bindings.map(function(binding){if(typeof binding.el.mozSrcObject!="undefined"){binding.el.mozSrcObject=stream}else{binding.el.src=media._createObjectURL(stream)||stream}if(typeof binding.el.play=="function"){binding.el.play()}return binding.el});waiting=elements.filter(function(el){return el.readyState<3});waiting.map(function(el){el.addEventListener("playing",playbackStarted,false)});checkWaiting()};Media.prototype._unbind=function(opts){opts=opts||{};this._bindings.forEach(function(binding){var element=binding.el;element.src=null;if(element.mozSrcObject){element.mozSrcObject=null}if(element.currentSrc){element.currentSrc=null}})};Media.prototype._createObjectURL=function(stream){try{return window.URL.createObjectURL(stream)}catch(e){}};Media.prototype._handleSuccess=function(stream){this.stream=stream;this.emit("stream",stream)};Media.prototype._handleFail=function(){this.emit("error",new Error("Unable to capture requested media"))}},{"cog/extend":11,"cog/logger":12,events:8,"rtc-core/detect":13,util:9}],15:[function(require,module,exports){"use strict";module.exports=function(scope){return function(args){try{scope.emit("announce",JSON.parse(args[0]))}catch(e){}}}},{}],16:[function(require,module,exports){"use strict";module.exports=function(scope){return{announce:require("./announce")(scope),request:require("./request")(scope)}}},{"./announce":15,"./request":17}],17:[function(require,module,exports){"use strict";module.exports=function(scope){var attributes=scope.attributes;function ackRequest(data){var listeners=scope.listeners("request");if(listeners&&listeners.length>0){}scope.send("/to",data.__srcid,"/ackreq",data.__reqid,scope.id)}return function(data){var match=true;var testKeys;try{data=JSON.parse(data)}catch(e){return false}testKeys=Object.keys(data).filter(function(key){return key.charAt(0)!=="_"});match=testKeys.reduce(function(memo,key){return memo&&attributes[key]===data[key]},match);if(match){if(scope.blocks.length){return scope.on("unblock",function(){ackRequest(data)})}return ackRequest(data)}return false}}},{}],18:[function(require,module,exports){"use strict";var EventEmitter=require("events").EventEmitter;var uuid=require("uuid");var extend=require("cog/extend");module.exports=function(messenger,opts){var signaller=new EventEmitter;var id=signaller.id=uuid.v4();var attributes=signaller.attributes={id:id};var dataEvent=(opts||{}).dataEvent||"data";var openEvent=(opts||{}).openEvent||"open";
signaller.blocks=[];signaller.matchers=[];function createChannel(targetId){return{send:function(){send.apply(null,["/to",targetId].concat([].slice.call(arguments)))}}}function prepareArg(arg){if(typeof arg=="object"&&!(arg instanceof String)){return JSON.stringify(arg)}else if(typeof arg=="function"){return null}return arg}function once(prefix,handler){signaller.matchers.push({prefix:prefix,handler:handler})}var send=signaller.send=function(){var args=[].slice.call(arguments);return messenger.send(args.map(prepareArg).filter(Boolean).join("|"))};signaller.announce=function(data,sender){extend(attributes,data,{id:id});return(sender||send)("/announce",attributes)};signaller.block=function(){var id=uuid.v4();signaller.blocks.push(id);return id};signaller.clearBlock=function(id){var wasBlocked=signaller.blocks.length>0;signaller.blocks=signaller.blocks.filter(function(blockId){return blockId!==id});if(wasBlocked&&signaller.blocks.length===0){signaller.emit("unblock")}};signaller.leave=function(){return send("/leave",{id:id})};signaller.request=function(data,opts,callback){var reqid=uuid.v4();if(typeof opts=="function"){callback=opts;opts={}}once("/ackreq|"+reqid,function(data){var targetId=data.split("|")[2];callback(null,createChannel(targetId))});send("/request",extend({},data,{__srcid:id,__reqid:reqid}))};signaller.to=function(targetId){var sender=function(){var args=["/to",targetId].concat([].slice.call(arguments));return messenger.send(args.map(prepareArg).filter(Boolean).join("|"))};return{announce:function(data){return signaller.announce(data,sender)},send:sender}};messenger.on(dataEvent,require("./processor")(signaller));messenger.on(openEvent,function(){signaller.emit("open")});return signaller}},{"./processor":20,"cog/extend":19,events:8,uuid:22}],19:[function(require,module,exports){"use strict";module.exports=function(target){[].slice.call(arguments,1).forEach(function(source){if(!source){return}for(var prop in source){target[prop]=source[prop]}});return target}},{}],20:[function(require,module,exports){"use strict";module.exports=function(scope){var id=scope.id;var handlers=require("./handlers")(scope);function sendEvent(parts){var evtName=parts[0].slice(1);var args=parts.slice(1).map(function(part){if(part.charAt(0)==="{"){try{part=JSON.parse(part)}catch(e){}}return part});scope.emit.apply(scope,[evtName].concat(args))}return function(data){var isMatch=true;var parts;var handler;if(data.slice(0,3)==="/to"){isMatch=data.slice(4,id.length+4)===id;if(isMatch){data=data.slice(5+id.length)}}if(!isMatch){return}parts=data.split("|");if(parts[0].charAt(0)==="/"){handler=handlers[parts[0].slice(1)];if(typeof handler=="function"){handler(parts.slice(1))}else{sendEvent(parts)}}scope.matchers=scope.matchers.filter(function(rule){var exec=data.slice(0,rule.prefix.length)===rule.prefix;if(exec&&typeof rule.handler=="function"){rule.handler(data)}return!exec})}}},{"./handlers":16}],21:[function(require,module,exports){var global=require("__browserify_global");var rng;if(global.crypto&&crypto.getRandomValues){var _rnds8=new Uint8Array(16);rng=function whatwgRNG(){crypto.getRandomValues(_rnds8);return _rnds8}}if(!rng){var _rnds=new Array(16);rng=function(){for(var i=0,r;i<16;i++){if((i&3)===0)r=Math.random()*4294967296;_rnds[i]=r>>>((i&3)<<3)&255}return _rnds}}module.exports=rng},{__browserify_global:23}],22:[function(require,module,exports){var _rng=require("./rng");var BufferClass=typeof Buffer=="function"?Buffer:Array;var _byteToHex=[];var _hexToByte={};for(var i=0;i<256;i++){_byteToHex[i]=(i+256).toString(16).substr(1);_hexToByte[_byteToHex[i]]=i}function parse(s,buf,offset){var i=buf&&offset||0,ii=0;buf=buf||[];s.toLowerCase().replace(/[0-9a-f]{2}/g,function(oct){if(ii<16){buf[i+ii++]=_hexToByte[oct]}});while(ii<16){buf[i+ii++]=0}return buf}function unparse(buf,offset){var i=offset||0,bth=_byteToHex;return bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]}var _seedBytes=_rng();var _nodeId=[_seedBytes[0]|1,_seedBytes[1],_seedBytes[2],_seedBytes[3],_seedBytes[4],_seedBytes[5]];var _clockseq=(_seedBytes[6]<<8|_seedBytes[7])&16383;var _lastMSecs=0,_lastNSecs=0;function v1(options,buf,offset){var i=buf&&offset||0;var b=buf||[];options=options||{};var clockseq=options.clockseq!==undefined?options.clockseq:_clockseq;var msecs=options.msecs!==undefined?options.msecs:(new Date).getTime();var nsecs=options.nsecs!==undefined?options.nsecs:_lastNSecs+1;var dt=msecs-_lastMSecs+(nsecs-_lastNSecs)/1e4;if(dt<0&&options.clockseq===undefined){clockseq=clockseq+1&16383}if((dt<0||msecs>_lastMSecs)&&options.nsecs===undefined){nsecs=0}if(nsecs>=1e4){throw new Error("uuid.v1(): Can't create more than 10M uuids/sec")}_lastMSecs=msecs;_lastNSecs=nsecs;_clockseq=clockseq;msecs+=122192928e5;var tl=((msecs&268435455)*1e4+nsecs)%4294967296;b[i++]=tl>>>24&255;b[i++]=tl>>>16&255;b[i++]=tl>>>8&255;b[i++]=tl&255;var tmh=msecs/4294967296*1e4&268435455;b[i++]=tmh>>>8&255;b[i++]=tmh&255;b[i++]=tmh>>>24&15|16;b[i++]=tmh>>>16&255;b[i++]=clockseq>>>8|128;b[i++]=clockseq&255;var node=options.node||_nodeId;for(var n=0;n<6;n++){b[i+n]=node[n]}return buf?buf:unparse(b)}function v4(options,buf,offset){var i=buf&&offset||0;if(typeof options=="string"){buf=options=="binary"?new BufferClass(16):null;options=null}options=options||{};var rnds=options.random||(options.rng||_rng)();rnds[6]=rnds[6]&15|64;rnds[8]=rnds[8]&63|128;if(buf){for(var ii=0;ii<16;ii++){buf[i+ii]=rnds[ii]}}return buf||unparse(rnds)}var uuid=v4;uuid.v1=v1;uuid.v4=v4;uuid.parse=parse;uuid.unparse=unparse;uuid.BufferClass=BufferClass;module.exports=uuid},{"./rng":21}],23:[function(require,module,exports){return{}},{}],24:[function(require,module,exports){module.exports=require(23)},{}]},{},[4])(4)});